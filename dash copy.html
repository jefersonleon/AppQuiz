<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Quiz AEE com Gr√°ficos</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .view { display: none; }
        .view.active { display: block; }
        .header { text-align: center; color: white; margin-bottom: 40px; position: relative; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .header .btn-logout {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .header .btn-logout:hover { background: rgba(255, 255, 255, 0.4); }
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .quiz-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease; border-left: 5px solid #667eea; text-align: center; }
        .quiz-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); border-left-color: #764ba2; }
        .quiz-card h2 { font-size: 1.5rem; color: #333; margin-bottom: 15px; }
        .quiz-card p { color: #666; margin-bottom: 20px; min-height: 50px; }
        .quiz-card button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .quiz-card button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .form-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 500px; margin: 0 auto; }
        .form-container h2 { color: #333; margin-bottom: 30px; font-size: 1.8rem; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
        .form-group input { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .button-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn-primary { flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { flex: 1; background: #e5e7eb; color: #333; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #d1d5db; }
        .quiz-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; border-radius: 10px; }
        .question-header { margin-bottom: 20px; }
        .question-number { color: #667eea; font-weight: 600; font-size: 0.9rem; margin-bottom: 10px; }
        .section-title { color: #666; font-size: 0.95rem; font-weight: 500; margin-bottom: 5px; }
        .question-text { font-size: 1.3rem; color: #333; font-weight: 600; margin-bottom: 30px; line-height: 1.5; }
        .options-container { display: grid; gap: 12px; margin-bottom: 30px; }
        .option-btn { padding: 15px 20px; border: 2px solid #e5e7eb; background: #f9fafb; border-radius: 10px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease; text-align: left; font-weight: 500; color: #333; }
        .option-btn:hover { border-color: #667eea; background: #f0f4ff; transform: translateX(5px); }
        .open-question { margin: 30px 0; padding: 20px; background: #f9fafb; border-radius: 10px; border-left: 4px solid #667eea; }
        .open-question textarea { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; min-height: 100px; transition: all 0.3s ease; }
        .open-question textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .results-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .results-card h2 { font-size: 2rem; color: #333; margin-bottom: 20px; }
        .percentage-display { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 15px; margin: 30px 0; font-size: 3rem; font-weight: 700; }
        .parecer-box { background: #f0f4ff; padding: 20px; border-radius: 10px; border-left: 5px solid #667eea; margin: 30px 0; text-align: left; }
        .parecer-box h3 { color: #667eea; margin-bottom: 10px; }
        .parecer-box p { color: #555; line-height: 1.6; }
        .btn-back { color: white; background: rgba(255,255,255,0.2); border: 2px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; margin-bottom: 30px; font-weight: 600; transition: all 0.3s ease; }
        .btn-back:hover { background: rgba(255,255,255,0.3); }
        .results-container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; margin-top: 40px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .results-header h3 { color: #333; font-size: 1.3rem; margin: 0; }
        .btn-chart { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s ease; }
        .btn-chart:hover { background: #059669; }
        .response-item { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea; }
        .response-item p { color: #555; margin: 5px 0; }
        .response-actions { display: flex; gap: 10px; margin-left: 20px; }
        .btn-small { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; }
        .btn-download { background: #10b981; color: white; }
        .btn-download:hover { background: #059669; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 15px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .chart-container { margin-bottom: 40px; }
        .chart-container h4 { text-align: center; margin-bottom: 15px; color: #333; font-size: 1.2rem; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .header .btn-logout { top: -10px; right: -10px; padding: 6px 12px; }
            .quiz-grid { grid-template-columns: 1fr; }
            .quiz-container, .form-container, .results-card { padding: 20px; }
            .percentage-display { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="view active" id="menuView">
            <div class="header">
                <h1>üéì Sistema de Quiz AEE</h1>
                <p id="welcomeMessage">Carregando...</p>
                <button class="btn-logout" onclick="app.logout()">Sair</button>
            </div>

            <div class="quiz-grid" id="quiz-grid">
                <div class="quiz-card" id="card-aee">
                    <h2>üë®‚Äçüè´</h2><h2>AEE</h2>
                    <p>Autoavalia√ß√£o Reflexiva sobre o Atendimento</p>
                    <button onclick="app.startQuiz('aee')">Iniciar</button>
                </div>
                <div class="quiz-card" id="card-familia">
                    <h2>üë®‚Äçüë©‚Äçüëß</h2><h2>Fam√≠lia</h2>
                    <p>Question√°rio para as Fam√≠lias</p>
                    <button onclick="app.startQuiz('familia')">Iniciar</button>
                </div>
                <div class="quiz-card" id="card-professor">
                    <h2>üìö</h2><h2>Professores</h2>
                    <p>Question√°rio para os Professores</p>
                    <button onclick="app.startQuiz('professor')">Iniciar</button>
                </div>
            </div>
            
            <div id="responsesContainer"></div>
        </div>

        <div class="view" id="formView">
            <button class="btn-back" onclick="app.backToMenu()">‚Üê Voltar</button>
            <div class="form-container">
                <h2>Informa√ß√µes do Respondente</h2>
                <div id="formFields"></div>
                <div class="button-group">
                    <button class="btn-primary" onclick="app.submitRespondentInfo()">Continuar</button>
                    <button class="btn-secondary" onclick="app.backToMenu()">Cancelar</button>
                </div>
            </div>
        </div>

        <div class="view" id="quizView">
            <button class="btn-back" onclick="app.backToMenu()">‚Üê Voltar</button>
            <div class="quiz-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="question-header">
                    <div class="question-number" id="questionNumber"></div>
                    <div class="section-title" id="sectionTitle"></div>
                </div>
                <div class="question-text" id="questionText"></div>
                <div class="options-container" id="optionsContainer"></div>
            </div>
        </div>

        <div class="view" id="resultsView">
            <button class="btn-back" onclick="app.backToMenu()">‚Üê Voltar</button>
            <div class="results-card">
                <h2>‚úÖ Obrigado!</h2>
                <p>Respostas registradas com sucesso</p>
                <div class="percentage-display" id="percentageDisplay">0%</div>
                <div class="parecer-box">
                    <h3>üìã Parecer:</h3><p id="parecer"></p>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="app.downloadReport()">‚¨áÔ∏è Baixar Relat√≥rio</button>
                    <button class="btn-secondary" onclick="app.backToMenu()">Voltar ao In√≠cio</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="app.closeChartModal()">&times;</span>
            <h2>Gr√°ficos Gerais de Respostas</h2>
            <div class="chart-container"><h4>Autoavalia√ß√£o AEE</h4><canvas id="aeeChart"></canvas></div>
            <div class="chart-container"><h4>Question√°rio para Fam√≠lia</h4><canvas id="familiaChart"></canvas></div>
            <div class="chart-container"><h4>Question√°rio para Professores</h4><canvas id="professorChart"></canvas></div>
        </div>
    </div>


    <script>
        // 1. COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
       const firebaseConfig = {
  apiKey: "AIzaSyAKKaP8m7oVKSCvIk0mV_CQH8xog5x3UMs",
  authDomain: "quizaee-59472.firebaseapp.com",
  databaseURL: "https://quizaee-59472-default-rtdb.firebaseio.com",
  projectId: "quizaee-59472",
  storageBucket: "quizaee-59472.firebasestorage.app",
  messagingSenderId: "26379620347",
  appId: "1:26379620347:web:dd20953fa71aa228a8c55e"
};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. O OBJETO 'quizzes'
        const quizzes = {
            aee: {
                title: 'Autoavalia√ß√£o Reflexiva sobre o Atendimento no AEE',
                sections: [{name: 'Reflex√£o sobre a Pr√°tica', questions: ['Tenho clareza dos objetivos do atendimento que realizo com cada aluno (a)?','Adoto estrat√©gias diversificadas para respeitar as singularidades e promover a inclus√£o de cada aluno (a)?','Promovo um espa√ßo seguro, afetivo e acolhedor durante o AEE?','Tenho escutado as necessidades dos alunos (as) de forma atenta e sens√≠vel?','Registro com consist√™ncia e qualidade o desenvolvimento dos alunos (as)?']},{name: 'Di√°logo com a Fam√≠lia', questions: ['Estabele√ßo uma comunica√ß√£o cont√≠nua e respeitosa com as fam√≠lias?','Escuto e valorizo a hist√≥ria de vida e os saberes que a fam√≠lia compartilha sobre o estudante?','Envolvo a fam√≠lia no processo de constru√ß√£o das estrat√©gias do AEE?']},{name: 'Olhar para Si', questions: ['Reconhe√ßo minhas limita√ß√µes e busco apoio quando necess√°rio?','Cuido da minha energia e bem-estar para estar inteira(o) no atendimento?','Sinto que estou cumprindo meu prop√≥sito no AEE?']}],
                options: ['Sempre', '√Äs vezes', 'Raramente', 'Nunca'],
                openQuestions: ['O que tem funcionado bem nos meus atendimentos no AEE?','O que pode ser aprimorado? Que a√ß√µes posso tomar para isso?'],
                formFields: [{ label: 'Nome do Professor(a)', key: 'nome', required: true },{ label: 'Data', key: 'data', type: 'date', required: false }]
            },
            familia: {
                title: 'Question√°rio para a Fam√≠lia',
                sections: [{name: 'Avalia√ß√£o Geral', questions: ['Voc√™ percebeu avan√ßos na aprendizagem do seu/sua filho (a) neste semestre?','O aluno apresenta maior autonomia na realiza√ß√£o das tarefas escolares?','Houve melhora na aten√ß√£o e concentra√ß√£o durante as atividades?','O atendimento no AEE contribuiu para a autoestima e confian√ßa do aluno (a)?','O aluno (a) demonstra interesse em participar das atividades escolares?','Voc√™ percebeu avan√ßos na comunica√ß√£o (oral, escrita, gestual ou alternativa)?','O aluno (a) apresenta maior iniciativa nas intera√ß√µes sociais com colegas e/ou familiares?','Em casa, o aluno mostra mais organiza√ß√£o em suas rotinas e tarefas?','Houve evolu√ß√£o no comportamento do aluno em rela√ß√£o √†s regras e limites?','O AEE tem contribu√≠do para a independ√™ncia do aluno no ambiente escolar?','O aluno apresenta avan√ßos na coordena√ß√£o motora ou uso de recursos adaptados?','Voc√™ percebeu melhora na resolu√ß√£o de problemas simples do dia a dia?','Seu filho (a) demonstra mais motiva√ß√£o para aprender?','O acompanhamento do AEE ajudou a reduzir barreiras de aprendizagem?','A comunica√ß√£o entre escola/AEE e fam√≠lia foi satisfat√≥ria neste semestre?','Voc√™ acredita que os objetivos do AEE para seu filho (a) est√£o sendo alcan√ßados?']}],
                options: ['Sim', 'Parcialmente', 'N√£o'],
                openQuestions: ['Deseja registrar alguma sugest√£o para aprimorar o atendimento do AEE?'],
                formFields: [{ label: 'Nome do Respons√°vel', key: 'nome', required: true },{ label: 'Nome do Aluno(a)', key: 'aluno', required: true },{ label: 'S√©rie/Ano', key: 'serie', required: false }]
            },
            professor: {
                title: 'Question√°rio para os Professores',
                sections: [{name: 'Desempenho e Participa√ß√£o', questions: ['O aluno (a) at√≠pico participa das atividades propostas em sala?','O aluno (a) demonstra interesse pelo conte√∫do ministrado?','O aluno consegue manter a aten√ß√£o durante as explica√ß√µes?','H√° necessidade frequente de adapta√ß√µes metodol√≥gicas para este aluno?','O aluno apresenta avan√ßos em sua aprendizagem ao longo do semestre?']},{name: 'Comportamento e Socializa√ß√£o', questions: ['O estudante demonstra autonomia na realiza√ß√£o das atividades?','O aluno interage de forma adequada com os colegas?','O aluno consegue acompanhar, mesmo que parcialmente, o ritmo da turma?','H√° evolu√ß√£o no comportamento do aluno durante as aulas?','O aluno participa de trabalhos em grupo de maneira colaborativa?']},{name: 'Desenvolvimento e Progresso', questions: ['O aluno demonstra motiva√ß√£o para aprender novos conte√∫dos?','O uso de recursos diferenciados (visuais, tecnol√≥gicos, pr√°ticos) auxilia no desempenho do aluno?','O aluno apresenta avan√ßos na comunica√ß√£o oral ou escrita durante as aulas?','O aluno aceita as orienta√ß√µes e interven√ß√µes do professor?','O aluno demonstra progresso em sua organiza√ß√£o pessoal (materiais, tarefas)?','A socializa√ß√£o do aluno melhorou ao longo do semestre?','O acompanhamento do AEE refletiu positivamente no desempenho em sua disciplina?','Voc√™ considera que a parceria entre professor regente, AEE e fam√≠lia tem sido efetiva?','O aluno demonstra evolu√ß√£o em habilidades socioemocionais (respeito, empatia, coopera√ß√£o)?','Voc√™ considera que os objetivos tra√ßados para o aluno at√≠pico em sua disciplina est√£o sendo alcan√ßados?']}],
                options: ['Sempre', '√Äs vezes', 'Raramente', 'Nunca'],
                openQuestions: ['Observa√ß√µes:'],
                formFields: [{ label: 'Nome do Professor(a)', key: 'nome', required: true },{ label: 'Disciplina', key: 'disciplina', required: false },{ label: 'Turma/S√©rie', key: 'turma', required: false },{ label: 'Nome do Aluno(a)', key: 'aluno', required: false }]
            }
        };

        // 3. O OBJETO 'app' (Com a l√≥gica 100% corrigida)
        const app = {
            state: {
                currentUser: null, userData: null, uid: null,
                currentQuiz: null, currentSection: 0, currentQuestion: 0,
                responses: [], respondentInfo: {}, lastReportData: null,
                allResponses: [], chartInstances: {}
            },

            init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const uid = user.uid;
                        
                        // O 'init()' est√° limpo, sem o 'try...catch' de diagn√≥stico.
                        // Se travar aqui em "Carregando...", √© 100% o erro "client is offline"
                        // que voc√™ resolve usando o "Live Server".
                        const userDoc = await db.collection('usuarios').doc(uid).get();

                        if (!userDoc.exists) {
                            alert("ERRO DE DADOS: Seu usu√°rio foi autenticado, mas n√£o encontramos seus dados (nome, tipo) no banco. Por favor, cadastre-se novamente ou contate o suporte."); 
                            auth.signOut(); 
                            return;
                        }

                        this.state.currentUser = user;
                        this.state.uid = uid;
                        this.state.userData = userDoc.data();
                        
                        document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${this.state.userData.nome}!`;
                        
                        // Esta fun√ß√£o agora est√° corrigida e vai funcionar
                        this.setupDashboardView();

                    } else {
                        window.location.href = 'index.html';
                    }
                });
            },

            logout() { 
                auth.signOut().then(() => { window.location.href = 'index.html'; }); 
            },

            // ================================================================
            // FUN√á√ÉO CORRIGIDA - setupDashboardView
            // Esta √© a vers√£o que funciona e mostra o quiz correto.
            // ================================================================
            async setupDashboardView() {
                this.hideAllViews();
                document.getElementById('menuView').classList.add('active');
                
                const cardAEE = document.getElementById('card-aee');
                const cardFamilia = document.getElementById('card-familia');
                const cardProfessor = document.getElementById('card-professor');
                const grid = document.getElementById('quiz-grid');
                
                // 1. Limpa o grid de qualquer mensagem de "Obrigado"
                grid.innerHTML = ''; 
                
                // 2. Re-adiciona os cards (Isso preserva os 'onclick')
                grid.appendChild(cardAEE);
                grid.appendChild(cardFamilia);
                grid.appendChild(cardProfessor);
                
                // 3. Reseta os estilos
                cardAEE.style.display = 'block';
                cardFamilia.style.display = 'block';
                cardProfessor.style.display = 'block';
                grid.style.gridTemplateColumns = ''; // Reseta para 3 colunas

                const tipo = this.state.userData.tipo;

                if (tipo === 'ADM') {
                    // ADM: Mostra tudo e carrega os resultados
                    document.getElementById('responsesContainer').style.display = 'block';
                    this.displayResponses();
                } else {
                    // USU√ÅRIO COMUM: Esconde os resultados
                    document.getElementById('responsesContainer').style.display = 'none';
                    
                    // Esconde todos os cards para come√ßar
                    cardAEE.style.display = 'none';
                    cardFamilia.style.display = 'none';
                    cardProfessor.style.display = 'none';

                    // Verifica se j√° respondeu
                    const respostaDoc = await db.collection('respostas').doc(this.state.uid).get();
                    
                    if (respostaDoc.exists) {
                        // Se j√° respondeu, mostra mensagem de "Obrigado"
                        grid.innerHTML = `<div class="results-card" style="grid-column: 1 / -1;"><h2>Obrigado por participar!</h2><p>Voc√™ j√° enviou suas respostas.</p></div>`;
                    } else {
                        // Se n√£o respondeu, mostra APENAS o card certo
                        if (tipo === 'aee') cardAEE.style.display = 'block';
                        else if (tipo === 'familia') cardFamilia.style.display = 'block';
                        else if (tipo === 'professor') cardProfessor.style.display = 'block';
                        
                        grid.style.gridTemplateColumns = '1fr'; // Centraliza o card
                    }
                }
            },
            // ================================================================
            // FIM DA FUN√á√ÉO CORRIGIDA
            // ================================================================

            startQuiz(quizType) {
                if (this.state.userData.tipo !== 'ADM' && this.state.userData.tipo !== quizType) {
                    alert("Voc√™ s√≥ pode responder o quiz do seu tipo de perfil."); return;
                }
                this.state.currentQuiz = quizType; this.state.currentSection = 0; this.state.currentQuestion = 0; this.state.responses = []; this.state.respondentInfo = {};
                this.showFormView();
            },

            showFormView() {
                this.hideAllViews(); document.getElementById('formView').classList.add('active');
                const quiz = quizzes[this.state.currentQuiz]; let html = '';
                quiz.formFields.forEach(field => {
                    let defaultValue = '';
                    if (field.key === 'nome' && this.state.userData.nome) defaultValue = this.state.userData.nome;
                    html += `<div class="form-group"><label for="${field.key}">${field.label}</label><input type="${field.type || 'text'}" id="${field.key}" placeholder="${field.label}" value="${defaultValue}" ${field.required ? 'required' : ''}/></div>`;
                });
                document.getElementById('formFields').innerHTML = html;
            },

            submitRespondentInfo() {
                const quiz = quizzes[this.state.currentQuiz]; const info = {}; let valid = true;
                quiz.formFields.forEach(field => {
                    const input = document.getElementById(field.key);
                    if (input) {
                        const value = input.value.trim();
                        if (field.required && !value) { alert(`Por favor, preencha: ${field.label}`); valid = false; }
                        info[field.key] = value;
                    }
                });
                if (valid) { this.state.respondentInfo = info; this.showQuizView(); }
            },

            showQuizView() { 
                this.hideAllViews(); document.getElementById('quizView').classList.add('active'); this.displayQuestion(); 
            },

            displayQuestion() {
                const quiz = quizzes[this.state.currentQuiz];
                const section = quiz.sections[this.state.currentSection];
                const question = section.questions[this.state.currentQuestion];
                const totalQuestions = quiz.sections.reduce((acc, s) => acc + s.questions.length, 0);
                const currentQuestionNumber = quiz.sections.slice(0, this.state.currentSection).reduce((acc, s) => acc + s.questions.length, 0) + this.state.currentQuestion + 1;
                document.getElementById('progressFill').style.width = (currentQuestionNumber / totalQuestions) * 100 + '%';
                document.getElementById('questionNumber').textContent = `Pergunta ${currentQuestionNumber} de ${totalQuestions}`;
                document.getElementById('sectionTitle').textContent = section.name;
                document.getElementById('questionText').textContent = question;
                let optionsHtml = '';
                quiz.options.forEach(option => { optionsHtml += `<button class="option-btn" onclick="app.selectOption('${option}')">${option}</button>`; });
                document.getElementById('optionsContainer').innerHTML = optionsHtml;
            },

            selectOption(option) {
                this.state.responses.push(option);
                const quiz = quizzes[this.state.currentQuiz];
                const section = quiz.sections[this.state.currentSection];
                if (this.state.currentQuestion + 1 >= section.questions.length) {
                    if (this.state.currentSection + 1 < quiz.sections.length) {
                        this.state.currentSection++; this.state.currentQuestion = 0; this.displayQuestion();
                    } else {
                        this.state.currentQuestion = 0; this.showOpenQuestions();
                    }
                } else {
                    this.state.currentQuestion++; this.displayQuestion();
                }
            },

            showOpenQuestions() {
                const quiz = quizzes[this.state.currentQuiz];
                if (!quiz.openQuestions || quiz.openQuestions.length === 0) { this.finishQuiz(); return; }
                this.hideAllViews(); document.getElementById('quizView').classList.add('active');
                const totalMultiChoice = quiz.sections.reduce((acc, s) => acc + s.questions.length, 0);
                const totalQuestions = totalMultiChoice + quiz.openQuestions.length;
                const currentQuestionNumber = totalMultiChoice + this.state.currentQuestion + 1;
                document.getElementById('progressFill').style.width = (currentQuestionNumber / totalQuestions) * 100 + '%';
                document.getElementById('questionNumber').textContent = `Pergunta Aberta ${this.state.currentQuestion + 1} de ${quiz.openQuestions.length}`;
                document.getElementById('sectionTitle').textContent = 'Perguntas Adicionais';
                document.getElementById('questionText').textContent = quiz.openQuestions[this.state.currentQuestion];
                const btnText = this.state.currentQuestion + 1 === quiz.openQuestions.length ? 'Finalizar' : 'Pr√≥xima';
                document.getElementById('optionsContainer').innerHTML = `<div class="open-question"><textarea id="openAnswer" placeholder="Escreva sua resposta aqui..."></textarea><div class="button-group" style="margin-top: 20px;"><button class="btn-primary" onclick="app.submitOpenAnswer()">${btnText}</button></div></div>`;
                document.getElementById('openAnswer').focus();
            },

            submitOpenAnswer() {
                const answer = document.getElementById('openAnswer').value.trim() || '[Sem resposta]';
                this.state.responses.push(answer);
                this.state.currentQuestion++;
                if (this.state.currentQuestion >= quizzes[this.state.currentQuiz].openQuestions.length) {
                    this.finishQuiz();
                } else { this.showOpenQuestions(); }
            },

            async finishQuiz() {
                const responseData = { type: this.state.currentQuiz, title: quizzes[this.state.currentQuiz].title, respondentInfo: this.state.respondentInfo, responses: this.state.responses, timestamp: new Date().toLocaleDateString('pt-BR'), time: new Date().toLocaleTimeString('pt-BR'), usuario_uid: this.state.uid, usuario_nome: this.state.userData.nome, usuario_tipo: this.state.userData.tipo };
                this.state.lastReportData = responseData;
                try {
                    await db.collection('respostas').doc(this.state.uid).set(responseData);
                    this.showResultsView(responseData);
                } catch (error) {
                    alert("Erro ao salvar sua resposta: " + error.message); console.error("Erro ao salvar no Firestore: ", error);
                }
            },

            showResultsView(responseData) {
                this.hideAllViews(); document.getElementById('resultsView').classList.add('active');
                const quiz = quizzes[responseData.type];
                const totalQuestionsMult = quiz.sections.reduce((acc, s) => acc + s.questions.length, 0);
                const positiveCount = responseData.responses.slice(0, totalQuestionsMult).filter(r => r === 'Sempre' || r === 'Sim').length;
                const percentage = totalQuestionsMult > 0 ? Math.round((positiveCount / totalQuestionsMult) * 100) : 0;
                document.getElementById('percentageDisplay').textContent = percentage + '%';
                let parecer = '';
                if (percentage >= 75) parecer = '‚úÖ Excelente desempenho! Continue mantendo as pr√°ticas bem-sucedidas.';
                else if (percentage >= 50) parecer = 'üìã Desempenho satisfat√≥rio. Identifique pontos de melhoria e desenvolva a√ß√µes.';
                else parecer = '‚ö†Ô∏è Desempenho abaixo do esperado. Recomenda-se apoio especializado.';
                document.getElementById('parecer').textContent = parecer;
            },

            downloadReport() { 
                this.generateReport(this.state.lastReportData); 
            },

            backToMenu() { 
                this.hideAllViews(); document.getElementById('menuView').classList.add('active'); this.setupDashboardView(); 
            },

            hideAllViews() { 
                document.querySelectorAll('.view').forEach(view => { view.classList.remove('active'); }); 
            },

            async displayResponses() {
                if (this.state.userData.tipo !== 'ADM') { document.getElementById('responsesContainer').style.display = 'none'; return; }
                document.getElementById('responsesContainer').style.display = 'block'; // Garante que ADM veja
                const container = document.getElementById('responsesContainer');
                const querySnapshot = await db.collection('respostas').orderBy('timestamp', 'desc').get();
                this.state.allResponses = [];
                querySnapshot.forEach(doc => { this.state.allResponses.push({ id: doc.id, ...doc.data() }); });
                if (this.state.allResponses.length === 0) { container.innerHTML = '<p style="text-align:center; color:white; margin-top: 30px;">Nenhuma resposta coletada ainda.</p>'; return; }
                let html = `<div class="results-container"><div class="results-header"><h3>üìä Respostas Coletadas (${this.state.allResponses.length})</h3><button class="btn-chart" onclick="app.showOverallCharts()">Ver Gr√°ficos Gerais</button></div>`;
                this.state.allResponses.forEach(response => {
                    const quiz = quizzes[response.type]; if (!quiz) return;
                    const totalQuestionsMult = quiz.sections.reduce((acc, s) => acc + s.questions.length, 0);
                    const positiveCount = response.responses.slice(0, totalQuestionsMult).filter(r => r === 'Sempre' || r === 'Sim').length;
                    const percentage = totalQuestionsMult > 0 ? Math.round((positiveCount / totalQuestionsMult) * 100) : 0;
                    html += `<div class="response-item"><div><p><strong>${response.type.toUpperCase()}</strong> - ${percentage}%</p><p style="font-size: 0.9rem; color: #666;">${response.respondentInfo.nome || response.usuario_nome}</p><p style="font-size: 0.85rem; color: #999;">${response.timestamp}</p></div><div class="response-actions"><button class="btn-small btn-download" onclick="app.downloadSingleReport('${response.id}')">‚¨áÔ∏è Baixar</button><button class="btn-small btn-delete" onclick="app.deleteResponse('${response.id}')">üóëÔ∏è Deletar</button></div></div>`;
                });
                container.innerHTML = html + `</div>`;
            },

            downloadSingleReport(id) { 
                const response = this.state.allResponses.find(r => r.id === id); 
                if (response) { this.generateReport(response); } else { alert("Erro: Relat√≥rio n√£o encontrado."); } 
            },

            generateReport(response) {
                if (!response) return;
                const quiz = quizzes[response.type]; let allQuestions = [];
                quiz.sections.forEach(section => { allQuestions = allQuestions.concat(section.questions); });
                const totalQuestionsMult = allQuestions.length;
                const responsesMulti = response.responses.slice(0, totalQuestionsMult);
                const responsesOpen = response.responses.slice(totalQuestionsMult);
                const positiveCount = responsesMulti.filter(r => r === 'Sempre' || r === 'Sim').length;
                const percentage = totalQuestionsMult > 0 ? Math.round((positiveCount / totalQuestionsMult) * 100) : 0;
                let report = `RELAT√ìRIO DE AVALIA√á√ÉO AEE\n================================\n\nTipo de Question√°rio: ${response.title}\nData: ${response.timestamp} - ${response.time}\n\nRESPONDENTE:\n`;
                Object.entries(response.respondentInfo).forEach(([key, value]) => { const label = quiz.formFields.find(f => f.key === key)?.label || key; report += `${label}: ${value || 'N√£o informado'}\n`; });
                report += `\n================================\nRESPOSTAS (M√öLTIPLA ESCOLHA):\n\n`;
                responsesMulti.forEach((ans, idx) => { report += `P${idx + 1}. ${allQuestions[idx]}\n   R: ${ans}\n\n`; });
                if (responsesOpen.length > 0 && quiz.openQuestions.length > 0) {
                    report += `================================\nRESPOSTAS (ABERTAS):\n\n`;
                    quiz.openQuestions.forEach((question, idx) => { report += `P${idx + 1}. ${question}\n   R: ${responsesOpen[idx] || '[Sem resposta]'}\n\n`; });
                }
                report += `================================\nPARECER:\n\nTaxa de Respostas Positivas: ${percentage}%\n`;
                if (percentage >= 75) report += `Status: EXCELENTE\nParecer: Continue mantendo as pr√°ticas bem-sucedidas!\n`;
                else if (percentage >= 50) report += `Status: SATISFAT√ìRIO\nParecer: Identifique pontos de melhoria e desenvolva a√ß√µes.\n`;
                else report += `Status: PRECISA MELHORAR\nParecer: Recomenda-se apoio e planejamento de interven√ß√µes.\n`;
                const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob); const element = document.createElement('a');
                element.href = url; element.download = `relatorio_aee_${response.id}.txt`;
                document.body.appendChild(element); element.click(); document.body.removeChild(element); URL.revokeObjectURL(url);
            },

            async deleteResponse(id) {
                if (confirm('Tem certeza que deseja deletar esta resposta? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    try {
                        await db.collection('respostas').doc(id).delete();
                        alert("Resposta deletada com sucesso."); this.displayResponses();
                    } catch (error) { alert("Erro ao deletar: " + error.message); }
                }
            },

            openChartModal() { 
                document.getElementById('chartModal').style.display = 'block'; 
            },

            closeChartModal() { 
                document.getElementById('chartModal').style.display = 'none'; 
            },

            showOverallCharts() {
                Object.values(this.state.chartInstances).forEach(chart => chart.destroy()); this.state.chartInstances = {};
                const data = this.aggregateChartData();
                if (Object.keys(data.aee).length > 0) this.createChart('aeeChart', 'AEE', data.aee, ['#667eea', '#764ba2', '#8e44ad', '#3498db']);
                if (Object.keys(data.familia).length > 0) this.createChart('familiaChart', 'Fam√≠lia', data.familia, ['#2ecc71', '#f1c4f0f', '#e74c3c']);
                if (Object.keys(data.professor).length > 0) this.createChart('professorChart', 'Professor', data.professor, ['#667eea', '#764ba2', '#8e44ad', '#3498db']);
                this.openChartModal();
            },

            aggregateChartData() {
                const chartData = { aee: {}, familia: {}, professor: {} };
                this.state.allResponses.forEach(response => {
                    const quiz = quizzes[response.type]; if (!quiz) return;
                    const totalQuestionsMult = quiz.sections.reduce((acc, s) => acc + s.questions.length, 0);
                    const multiChoiceResponses = response.responses.slice(0, totalQuestionsMult);
                    multiChoiceResponses.forEach(answer => {
                        if (!chartData[response.type][answer]) { chartData[response.type][answer] = 0; }
                        chartData[response.type][answer]++;
                    });
                });
                return chartData;
            },

            createChart(canvasId, label, data, backgroundColors) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                this.state.chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: Object.keys(data), datasets: [{ label: `Contagem - ${label}`, data: Object.values(data), backgroundColor: backgroundColors, borderWidth: 1 }] },
                    options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                });
            }
        }; // Fim do objeto 'app'

        // 4. PONTO DE ENTRADA DA APLICA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>